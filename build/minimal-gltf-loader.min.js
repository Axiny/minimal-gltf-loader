var MinimalGLTFLoader=MinimalGLTFLoader||{};!function(){"use strict";function e(e){var s="",t=e.lastIndexOf("/");return-1!==t&&(s=e.substring(0,t+1)),s}function s(e,s){var t=new XMLHttpRequest;t.overrideMimeType("application/json"),t.open("GET",e,!0),t.onreadystatechange=function(){4==t.readyState&&"200"==t.status&&s(t.responseText,this)},t.send(null)}function t(e,s){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.open("GET",e,!0),t.onreadystatechange=function(){if(4==t.readyState&&"200"==t.status){var e=t.response;e&&s&&s(e)}},t.send(null)}function i(e,s,t){var i=new Image;i.src=e,i.onload=function(){t(i,s)}}var n,r=MinimalGLTFLoader.Scene=function(){this.nodes=[],this.meshes=[]},a=MinimalGLTFLoader.Accessor=function(e,s){this.bufferView=s,this.componentType=e.componentType,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=s.byteStride,this.normalized=void 0!==e.normalized?e.normalized:!1,this.count=e.count,this.type=e.type,this.size=p[this.type]},o=MinimalGLTFLoader.BufferView=function(e,s){this.byteLength=e.byteLength,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=void 0!==e.byteStride?e.byteStride:0,this.target=void 0!==e.target?e.target:null,this.data=s.slice(this.byteOffset,this.byteOffset+this.byteLength),this.buffer=null},f=MinimalGLTFLoader.Node=function(){this.matrix=mat4.create(),this.children=[],this.mesh=null},h=MinimalGLTFLoader.Mesh=function(){this.meshID=-1,this.primitives=[]},d=MinimalGLTFLoader.Primitive=function(e,s){this.attributes=s.attributes,this.indices=void 0!==s.indices?s.indices:null,this.indicesComponentType=e.accessors[this.indices].componentType,this.indicesLength=e.accessors[this.indices].count,this.indicesOffset=e.accessors[this.indices].byteOffset||0,this.material=void 0!==s.material?e.materials[s.material]:null,this.mode=void 0!==s.mode?s.mode:4,this.targets=s.targets,this.vertexArray=null,this.vertexBuffer=null,this.indexBuffer=null},c=MinimalGLTFLoader.glTFModel=function(e){this.json=e,this.defaultScene=e.scene,this.version=Number(e.asset.version),e.accessors&&(this.accessors=new Array(e.accessors.length)),e.bufferViews&&(this.bufferViews=new Array(e.bufferViews.length)),e.scenes&&(this.scenes=new Array(e.scenes.length)),e.nodes&&(this.nodes=new Array(e.nodes.length)),e.meshes&&(this.meshes=new Array(e.meshes.length)),this.shaders={},this.programs={},e.images&&(this.images=new Array(e.images.length))},u=MinimalGLTFLoader.glTFLoader=function(e){n=void 0!==e?e:null,this._init(),this.glTF=null};u.prototype._init=function(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._shaderRequested=0,this._shaderLoaded=0,this._imageRequested=0,this._imageLoaded=0,this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null},u.prototype._getBufferViewData=function(e,s,t){var i=this.glTF.bufferViews[s];if(void 0===i){var n=e.bufferViews[s],r=this._buffers[n.buffer];if(r)console.log("dependent buffer data ready (instant), create bufferView "+s),this.glTF.bufferViews[s]=i=new o(n,r),t(i);else{this._pendingTasks++;var a=this._bufferTasks[n.buffer];a||(this._bufferTasks[n.buffer]=[],a=this._bufferTasks[n.buffer]);var f=this;a.push(function(e){f._finishedPendingTasks++,i=f.glTF.bufferViews[s],void 0===i?(console.log("create new BufferView Data for "+s),i=f.glTF.bufferViews[s]=new o(n,e)):console.log("dependent buffer data ready (queued), create bufferView "+s),t(i),f._checkComplete()})}}else console.log("use cached bufferView "+s),t(i)},u.prototype._checkComplete=function(){this._bufferRequested==this._bufferLoaded&&this._imageRequested==this._imageLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks==this._finishedPendingTasks&&this.onload(this.glTF)},u.prototype._parseGLTF=function(e){var s,t,i,n=this;if(e.accessors)for(s=0,t=e.accessors.length;t>s;s++)i=e.accessors[s],void 0!==i.bufferView&&this._getBufferViewData(e,i.bufferView,function(){var t=e.accessors[s],i=s;return function(e){n.glTF.accessors[i]=new a(t,e)}}());if(e.scenes)for(var o=0,f=e.scenes.length;f>o;o++){var h=new r;this.glTF.scenes[o]=h;for(var d=e.scenes[o],c=d.nodes,u=c.length,l=0;u>l;++l){var m=c[l];this._parseNode(e,m,h.nodes)}}this._parseDone=!0,this._checkComplete()},u.prototype._parseMesh=function(e,s){if(void 0===this.glTF.meshes[s]){var t=new h;this.glTF.meshes[s]=t;for(var i,n=e.meshes[s],r=n.primitives,a=r.length,o=0;a>o;++o)i=r[o],t.primitives.push(new d(e,i))}};var l=vec3.create(),m=quat.create(),g=vec3.create(),b=mat4.create();u.prototype._parseNode=function(e,s,t){if(void 0===this.glTF.nodes[s]){var i=e.nodes[s],n=new f;this.glTF.nodes[s]=n,t.push(s);var r=n.matrix;if(i.hasOwnProperty("matrix"))for(var a=0;16>a;++a)r[a]=i.matrix[a];else i.translation?vec3.set(l,i.translation[0],i.translation[1],i.translation[2]):vec3.set(l,0,0,0),i.rotation?quat.set(m,i.rotation[0],i.rotation[1],i.rotation[2],i.rotation[3]):quat.set(m,0,0,0,1),i.scale?vec3.set(g,i.scale[0],i.scale[1],i.scale[2]):vec3.set(g,1,1,1),mat4.fromRotationTranslation(b,m,l),mat4.scale(r,b,g);void 0!==i.mesh&&(n.mesh=i.mesh,this._parseMesh(e,i.mesh));var o=i.children;if(o)for(var h=o.length,d=0;h>d;++d){var c=o[d];this._parseNode(e,c,n.children)}}},u.prototype.loadGLTF=function(n,r){this._init(),this.onload=r||function(e){console.log("glTF model loaded."),console.log(e)},this.baseUri=e(n);var a=this;s(n,function(e){var s=JSON.parse(e);a.glTF=new c(s);var n,r=function(e){if(a._buffers[n]=e,a._bufferLoaded++,a._bufferTasks[n]){var s,t;for(s=0,t=a._bufferTasks[n].length;t>s;++s)a._bufferTasks[n][s](e)}a._checkComplete()};if(s.buffers)for(n in s.buffers)a._bufferRequested++,t(a.baseUri+s.buffers[n].uri,r);var o,f=function(e,s){a._imageLoaded++,a.glTF.images[s]=e,a._checkComplete()};if(s.images)for(o in s.images)a._imageRequested++,i(a.baseUri+s.images[o].uri,o,f);a._parseGLTF(s)})};var p={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};MinimalGLTFLoader.Attributes=["POSITION","NORMAL","TEXCOORD","COLOR","JOINT","WEIGHT"]}();