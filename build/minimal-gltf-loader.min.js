var MinimalGLTFLoader=MinimalGLTFLoader||{};!function(){"use strict";function e(e,t,r,s){switch(s){case 5122:return new Int16Array(e,t,r);case 5123:return new Uint16Array(e,t,r);case 5124:return new Int32Array(e,t,r);case 5125:return new Uint32Array(e,t,r);case 5126:return new Float32Array(e,t,r);default:return null}}function t(t,r){return e(t,r.byteOffset,r.count*b[r.type],r.componentType)}function r(e){var t="",r=e.lastIndexOf("/");return-1!==r&&(t=e.substring(0,r+1)),t}function s(e,t){var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",e,!0),r.onreadystatechange=function(){4==r.readyState&&"200"==r.status&&t(r.responseText,this)},r.send(null)}function a(e,t){var r=new XMLHttpRequest;r.responseType="arraybuffer",r.open("GET",e,!0),r.onreadystatechange=function(){if(4==r.readyState&&"200"==r.status){var e=r.response;e&&t&&t(e)}},r.send(null)}function i(e,t){var r=new XMLHttpRequest;r.responseType="text",r.open("GET",e,!0),r.onreadystatechange=function(){if(4==r.readyState&&"200"==r.status){var e=r.response;e&&t&&t(e)}},r.send(null)}function n(e,t,r){var s=e.createShader(r);return e.shaderSource(s,t),e.compileShader(s),s}function o(e,t,r){var s=e.createProgram(),a=n(e,t,e.VERTEX_SHADER),i=n(e,r,e.FRAGMENT_SHADER);e.attachShader(s,a),e.deleteShader(a),e.attachShader(s,i),e.deleteShader(i),e.linkProgram(s);var o=e.getProgramInfoLog(s);return o&&console.log(o),o=e.getShaderInfoLog(a),o&&console.log(o),o=e.getShaderInfoLog(i),o&&console.log(o),s}var f,h=MinimalGLTFLoader.Scene=function(){this.meshes=[]},u=MinimalGLTFLoader.Mesh=function(){this.meshID="",this.primitives=[]},c=MinimalGLTFLoader.Primitive=function(){this.mode=4,this.matrix=mat4.create(),this.indices=null,this.indicesComponentType=5123,this.vertexBuffer=null,this.attributes={},this.material=null,this.technique=null},d=MinimalGLTFLoader.glTFModel=function(){this.defaultScene="",this.scenes={},this.nodeMatrix={},this.json=null,this.shaders={},this.programs={}},l=MinimalGLTFLoader.glTFLoader=function(e){f=e,this._init(),this.glTF=null};l.prototype._init=function(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._bufferViews={},this._shaderRequested=0,this._shaderLoaded=0,this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null},l.prototype._getBufferViewData=function(e,t,r){var s=this._bufferViews[t];if(s)r(s);else{var a=e.bufferViews[t],i=this._buffers[a.buffer];if(i)this._bufferViews[t]=i.slice(a.byteOffset,a.byteOffset+a.byteLength),r(s);else{this._pendingTasks++;var n=this._bufferTasks[a.buffer];n||(this._bufferTasks[a.buffer]=[],n=this._bufferTasks[a.buffer]);var o=this;n.push(function(e){var s=o._bufferViews[t];s||(console.log("create new BufferView Data for "+t),s=o._bufferViews[t]=e.slice(a.byteOffset,a.byteOffset+a.byteLength)),o._finishedPendingTasks++,r(s)})}}},l.prototype._checkComplete=function(){this._bufferRequested==this._bufferLoaded&&this._shaderRequested==this._shaderLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks==this._finishedPendingTasks&&this.onload(this.glTF)},l.prototype._parseGLTF=function(e){if(this.glTF.json=e,this.glTF.defaultScene=e.scene,e.scenes)for(var t in e.scenes){var r=new h;this.glTF.scenes[t]=r;for(var s=e.scenes[t],a=s.nodes,i=a.length,n=0;i>n;++n){var o=a[n];this._parseNode(e,o,r)}}this._parseDone=!0,this._checkComplete()};var p=vec3.create(),m=quat.create(),_=vec3.create(),v=mat4.create();l.prototype._parseNode=function(e,t,r,s){var a=e.nodes[t];void 0===s&&(s=mat4.create());var i=mat4.create();if(a.hasOwnProperty("matrix")){for(var n=0;16>n;++n)i[n]=a.matrix[n];mat4.multiply(i,s,i)}else vec3.set(p,a.translation[0],a.translation[1],a.translation[2]),quat.set(m,a.rotation[0],a.rotation[1],a.rotation[2],a.rotation[3]),mat4.fromRotationTranslation(v,m,p),mat4.multiply(i,i,v),vec3.set(_,a.scale[0],a.scale[1],a.scale[2]),mat4.scale(i,i,_);this.glTF.nodeMatrix[t]=i;var o=a.meshes;if(o)for(var f=o.length,h=0;f>h;++h){var d=new u;r.meshes.push(d);var l=o[h],g=e.meshes[l];d.meshID=l;for(var b=g.primitives,T=b.length,y=0;T>y;++y){var L=new c;d.primitives.push(L);var S=b[y];S.indices&&this._parseIndices(e,S,L),this._parseAttributes(e,S,L,i),L.material=e.materials[S.material],L.material.technique&&(L.technique=e.techniques[L.material.technique])}}for(var w=a.children,F=w.length,k=0;F>k;++k){var M=w[k];this._parseNode(e,M,r,i)}},l.prototype._parseIndices=function(e,r,s){var a=r.indices,i=e.accessors[a];s.mode=r.mode||4,s.indicesComponentType=i.componentType;var n=this;this._getBufferViewData(e,i.bufferView,function(e){s.indices=t(e,i),n._checkComplete()})},l.prototype._parseAttributes=function(t,r,s,a){var i=Object.keys(r.attributes)[0],n=t.accessors[r.attributes[i]],o=n.bufferView,f=t.bufferViews[o],h=this;this._getBufferViewData(t,o,function(i){s.vertexBuffer=e(i,0,f.byteLength/g[n.componentType],n.componentType);for(var o in r.attributes){var u=r.attributes[o],c=t.accessors[u],d=g[c.componentType];c.byteStride/d,c.byteOffset/d,c.count;mat4.copy(s.matrix,a),s.attributes[o]={size:b[c.type],type:c.componentType,stride:c.byteStride,offset:c.byteOffset}}h._checkComplete()})},l.prototype.loadGLTF=function(e,t){this._init(),this.onload=t||function(e){console.log("glTF model loaded."),console.log(e)},this.glTF=new d,this.baseUri=r(e);var n=this;s(e,function(e){var t,r=JSON.parse(e),s=function(e){if(n._buffers[t]=e,n._bufferLoaded++,n._bufferTasks[t]){var r,s;for(r=0,s=n._bufferTasks[t].length;s>r;++r)n._bufferTasks[t][r](e)}n._checkComplete()};if(r.buffers)for(t in r.buffers)n._bufferRequested++,a(n.baseUri+"/"+r.buffers[t].uri,s);var h,u,c=function(e){n._shaderLoaded++,u.vertexShader=e,u.fragmentShader&&(u.program=o(f,u.vertexShader,u.fragmentShader),n._checkComplete())},d=function(e){n._shaderLoaded++,u.fragmentShader=e,u.vertexShader&&(u.program=o(f,u.vertexShader,u.fragmentShader),n._checkComplete())};if(r.programs)for(h in r.programs){u=n.glTF.programs[h]={vertexShader:null,fragmentShader:null,program:null};var l=r.programs[h];n._shaderRequested+=2,i(n.baseUri+"/"+r.shaders[l.vertexShader].uri,c),i(n.baseUri+"/"+r.shaders[l.fragmentShader].uri,d)}n._parseGLTF(r)})};var g={5120:1,5121:1,5122:2,5123:2,5126:4},b={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};MinimalGLTFLoader.Attributes=["POSITION","NORMAL","TEXCOORD","COLOR","JOINT","WEIGHT"]}();