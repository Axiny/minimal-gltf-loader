var MinimalGLTFLoader=MinimalGLTFLoader||{};!function(){"use strict";function e(e,t,s,i){switch(i){case 5122:return new Int16Array(e,t,s);case 5123:return new Uint16Array(e,t,s);case 5126:return new Float32Array(e,t,s);default:return null}}function t(t,s){return e(t,s.byteOffset,s.count*b[s.type],s.componentType)}function s(e){var t="",s=e.lastIndexOf("/");return-1!==s&&(t=e.substring(0,s+1)),t}function i(e,t){var s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("GET",e,!0),s.onreadystatechange=function(){4==s.readyState&&"200"==s.status&&t(s.responseText,this)},s.send(null)}function n(e,t){var s=new XMLHttpRequest;s.responseType="arraybuffer",s.open("GET",e,!0),s.onreadystatechange=function(){if(4==s.readyState&&"200"==s.status){var e=s.response;e&&t&&t(e)}},s.send(null)}var r=MinimalGLTFLoader.Scene=function(){this.meshes=[]},a=MinimalGLTFLoader.Mesh=function(){this.meshID="",this.primitives=[]},o=MinimalGLTFLoader.Primitive=function(){this.mode=4,this.indices=null,this.indicesComponentType=5123,this.vertexBuffer=null,this.matrix=mat4.create(),this.attributes={}},f=MinimalGLTFLoader.glTFModel=function(){this.defaultScene="",this.scenes={},this.json=null},u=MinimalGLTFLoader.glTFLoader=function(){this._init(),this.glTF=null};u.prototype._init=function(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._bufferViews={},this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null},u.prototype._getBufferViewData=function(e,t,s){var i=this._bufferViews[t];if(i)s(i);else{var n=e.bufferViews[t],r=this._buffers[n.buffer];if(r)this._bufferViews[t]=r.slice(n.byteOffset,n.byteOffset+n.byteLength),s(i);else{this._pendingTasks++;var a=this._bufferTasks[n.buffer];a||(this._bufferTasks[n.buffer]=[],a=this._bufferTasks[n.buffer]);var o=this;a.push(function(e){var i=o._bufferViews[t];i||(console.log("create new BufferView Data for "+t),i=o._bufferViews[t]=e.slice(n.byteOffset,n.byteOffset+n.byteLength)),o._finishedPendingTasks++,s(i)})}}},u.prototype._checkComplete=function(){this._bufferRequested==this._bufferLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks==this._finishedPendingTasks&&this.onload(this.glTF)},u.prototype._parseGLTF=function(e){this.glTF.json=e,this.glTF.defaultScene=e.scene;for(var t in e.scenes){var s=new r;this.glTF.scenes[t]=s;for(var i=e.scenes[t],n=i.nodes,a=n.length,o=0;a>o;++o){var f=n[o],u=e.nodes[f];this._parseNode(e,u,s)}}this._parseDone=!0,this._checkComplete()};var c=vec3.create(),h=quat.create(),l=vec3.create(),p=mat4.create();u.prototype._parseNode=function(e,t,s,i){void 0===i&&(i=mat4.create());var n=mat4.create();if(t.hasOwnProperty("matrix")){for(var r=0;16>r;++r)n[r]=t.matrix[r];mat4.multiply(n,i,n)}else vec3.set(c,t.translation[0],t.translation[1],t.translation[2]),quat.set(h,t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3]),mat4.fromRotationTranslation(p,h,c),mat4.multiply(n,n,p),vec3.set(l,t.scale[0],t.scale[1],t.scale[2]),mat4.scale(n,n,l);var f=t.meshes;if(f)for(var u=f.length,d=0;u>d;++d){var b=new a;s.meshes.push(b);var T=f[d],_=e.meshes[T];b.meshID=T;for(var m=_.primitives,v=m.length,y=0;v>y;++y){var g=new o;b.primitives.push(g);var L=m[y];L.indices&&this._parseIndices(e,L,g),this._parseAttributes(e,L,g,n)}}for(var w=t.children,F=w.length,k=0;F>k;++k){var O=w[k],M=e.nodes[O];this._parseNode(e,M,s,n)}},u.prototype._parseIndices=function(e,s,i){var n=s.indices,r=e.accessors[n];i.mode=s.mode||4,i.indicesComponentType=r.componentType;var a=this;this._getBufferViewData(e,r.bufferView,function(e){i.indices=t(e,r),a._checkComplete()})},u.prototype._parseAttributes=function(t,s,i,n){var r=Object.keys(s.attributes)[0],a=t.accessors[s.attributes[r]],o=a.bufferView,f=t.bufferViews[o],u=this;this._getBufferViewData(t,o,function(r){i.vertexBuffer=e(r,0,f.byteLength/d[a.componentType],a.componentType);for(var o in s.attributes){var c=s.attributes[o],h=t.accessors[c],l=d[h.componentType];h.byteStride/l,h.byteOffset/l,h.count;mat4.copy(i.matrix,n),i.attributes[o]={size:b[h.type],type:h.componentType,stride:h.byteStride,offset:h.byteOffset}}u._checkComplete()})},u.prototype.loadGLTF=function(e,t){this._init(),this.onload=t||function(e){console.log("glTF model loaded."),console.log(e)},this.glTF=new f,this.baseUri=s(e);var r=this;i(e,function(e){var t,s=JSON.parse(e),i=function(e){if(r._buffers[t]=e,r._bufferLoaded++,r._bufferTasks[t]){var s,i;for(s=0,i=r._bufferTasks[t].length;i>s;++s)r._bufferTasks[t][s](e)}r._checkComplete()};if(s.buffers)for(t in s.buffers)r._bufferRequested++,n(r.baseUri+"/"+s.buffers[t].uri,i);r._parseGLTF(s)})};var d={5120:1,5121:1,5122:2,5123:2,5126:4},b={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};MinimalGLTFLoader.Attributes=["POSITION","NORMAL","TEXCOORD","COLOR","JOINT","WEIGHT"]}();