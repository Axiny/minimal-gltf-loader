var MinimalGLTFLoader=MinimalGLTFLoader||{};!function(){"use strict";function e(e){var t="",s=e.lastIndexOf("/");return-1!==s&&(t=e.substring(0,s+1)),t}function t(e,t){var s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("GET",e,!0),s.onreadystatechange=function(){4==s.readyState&&"200"==s.status&&t(s.responseText,this)},s.send(null)}function s(e,t){var s=new XMLHttpRequest;s.responseType="arraybuffer",s.open("GET",e,!0),s.onreadystatechange=function(){if(4==s.readyState&&"200"==s.status){var e=s.response;e&&t&&t(e)}},s.send(null)}function i(e,t,s){var i=new Image;i.crossOrigin="Anonymous",i.src=e,i.onload=function(){s(i,t)}}var r=null,a=MinimalGLTFLoader.Scene=function(){this.nodes=[],this.boundingBox=null},n=MinimalGLTFLoader.BoundingBox=function(e,t,s){e=e||vec3.fromValues(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),t=t||vec3.fromValues(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),void 0===s||s===!0?(this.min=vec3.clone(e),this.max=vec3.clone(t)):(this.min=e,this.max=t),this.transform=mat4.create()};n.prototype.updateBoundingBox=function(e){vec3.min(this.min,this.min,e.min),vec3.max(this.max,this.max,e.max)},n.prototype.calculateTransform=function(){this.transform[0]=this.max[0]-this.min[0],this.transform[5]=this.max[1]-this.min[1],this.transform[10]=this.max[2]-this.min[2],this.transform[12]=this.min[0],this.transform[13]=this.min[1],this.transform[14]=this.min[2]},n.getAABBFromOBB=function(){var e=vec3.create(),t=vec3.create(),s=vec3.create(),i=vec3.create(),r=vec3.create();return function(a,o){vec3.set(e,o[0],o[1],o[2]),vec3.set(t,o[4],o[5],o[6]),vec3.set(s,o[8],o[9],o[10]);var l=vec3.fromValues(o[12],o[13],o[14]),h=vec3.clone(l);vec3.scale(i,e,a.min[0]),vec3.scale(r,e,a.max[0]),vec3.min(e,i,r),vec3.add(l,l,e),vec3.max(e,i,r),vec3.add(h,h,e),vec3.scale(i,t,a.min[1]),vec3.scale(r,t,a.max[1]),vec3.min(t,i,r),vec3.add(l,l,t),vec3.max(t,i,r),vec3.add(h,h,t),vec3.scale(i,s,a.min[2]),vec3.scale(r,s,a.max[2]),vec3.min(s,i,r),vec3.add(l,l,s),vec3.max(s,i,r),vec3.add(h,h,s);var u=new n(l,h,!1);return u.calculateTransform(),u}}();var o=MinimalGLTFLoader.Accessor=function(e,t){this.bufferView=t,this.componentType=e.componentType,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=t.byteStride,this.normalized=void 0!==e.normalized?e.normalized:!1,this.count=e.count,this.type=e.type,this.size=w[this.type],this.min=e.min,this.max=e.max},l=MinimalGLTFLoader.BufferView=function(e,t){this.byteLength=e.byteLength,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=void 0!==e.byteStride?e.byteStride:0,this.target=void 0!==e.target?e.target:null,this.data=t.slice(this.byteOffset,this.byteOffset+this.byteLength),this.buffer=null};l.prototype.createBuffer=function(e){this.buffer=e.createBuffer()},l.prototype.bindData=function(e){return this.target?(e.bindBuffer(this.target,this.buffer),e.bufferData(this.target,this.data,e.STATIC_DRAW),e.bindBuffer(this.target,null),!0):!1};var h=MinimalGLTFLoader.Node=function(e){this.nodeID=e,this.matrix=mat4.create(),this.children=[],this.mesh=null,this.aabb=null,this.bvh=new n};h.prototype.traverse=function(e,t){t(this,e);for(var s=0,i=this.children.length;i>s;s++)this.children[s].traverse(this,t)},h.prototype.traversePostOrder=function(e,t){for(var s=0,i=this.children.length;i>s;s++)this.children[s].traversePostOrder(this,t);t(this,e)},h.prototype.traverseTwoExecFun=function(e,t,s){t(this,e);for(var i=0,r=this.children.length;r>i;i++)this.children[i].traverseTwoExecFun(this,t,s);s(this,e)};var u=MinimalGLTFLoader.Mesh=function(){this.meshID=-1,this.primitives=[],this.boundingBox=null},c=MinimalGLTFLoader.Primitive=function(e,t){this.attributes=t.attributes,this.indices=void 0!==t.indices?t.indices:null,this.indicesComponentType=e.accessors[this.indices].componentType,this.indicesLength=e.accessors[this.indices].count,this.indicesOffset=e.accessors[this.indices].byteOffset||0,this.material=void 0!==t.material?r.materials[t.material]:null,this.mode=void 0!==t.mode?t.mode:4,this.targets=t.targets,this.vertexArray=null,this.vertexBuffer=null,this.indexBuffer=null,this.boundingBox=null},m=MinimalGLTFLoader.Texture=function(e){this.sampler=void 0!==e.sampler?e.sampler:null,this.source=void 0!==e.source?e.source:null,this.texture=null};m.prototype.createTexture=function(e,t){t.activeTexture(t.TEXTURE0+e),this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.source),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)};var f=MinimalGLTFLoader.Sampler=function(e){this.magFilter=void 0!==e.magFilter?e.magFilter:null,this.minFilter=void 0!==e.minFilter?e.minFilter:null,this.wrapS=void 0!==e.wrapS?e.wrapS:10497,this.wrapT=void 0!==e.wrapT?e.wrapT:10497,this.sampler=null};f.prototype.createSampler=function(e){this.sampler=e.createSampler(),this.minFilter?e.samplerParameteri(this.sampler,e.TEXTURE_MIN_FILTER,this.minFilter):e.samplerParameteri(this.sampler,e.TEXTURE_MIN_FILTER,e.NEAREST_MIPMAP_LINEAR),this.magFilter?e.samplerParameteri(this.sampler,e.TEXTURE_MAG_FILTER,this.magFilter):e.samplerParameteri(this.sampler,e.TEXTURE_MAG_FILTER,e.LINEAR),e.samplerParameteri(this.sampler,e.TEXTURE_WRAP_S,this.wrapS),e.samplerParameteri(this.sampler,e.TEXTURE_WRAP_T,this.wrapT)};var d,T=MinimalGLTFLoader.TextureInfo=function(e){this.index=e.index,this.texCoord=void 0!==e.texCoord?e.texCoord:0},v=(MinimalGLTFLoader.PbrMetallicRoughness=function(e){this.baseColorFactor=void 0!==e.baseColorFactor?e.baseColorFactor:[1,1,1,1],this.baseColorTexture=void 0!==e.baseColorTexture?new T(e.baseColorTexture):null,this.metallicFactor=void 0!==e.metallicFactor?e.metallicFactor:1,this.roughnessFactor=void 0!==e.roughnessFactor?e.roughnessFactor:1,this.metallicRoughnessTexture=void 0!==e.metallicRoughnessTexture?new T(e.metallicRoughnessTexture):null},MinimalGLTFLoader.NormalTextureInfo=function(e){this.index=e.index,this.texCoord=void 0!==e.texCoord?e.texCoord:0,this.scale=void 0!==e.scale?e.scale:1}),g=MinimalGLTFLoader.Material=function(e){this.name=void 0!==e.name?e.name:null,this.pbrMetallicRoughness=void 0!==e.pbrMetallicRoughness?e.pbrMetallicRoughness:null,this.normalTexture=void 0!==e.normalTexture?new v(e.normalTexture):null,this.occlusionTexture=void 0!==e.occlusionTexture?e.occlusionTexture:null,this.emissiveTexture=void 0!==e.emissiveTexture?e.emissiveTexture:null,this.emissiveFactor=void 0!==e.emissiveFactor?e.emissiveFactor:[0,0,0],this.alphaMode=void 0!==e.alphaMode?e.alphaMode:"OPAQUE",this.alphaCutoff=void 0!==e.alphaCutoff?e.alphaCutoff:.5,this.doubleSided=e.doubleSided||!1},p=MinimalGLTFLoader.glTFModel=function(e){this.json=e,this.defaultScene=e.scene,this.version=Number(e.asset.version),e.accessors&&(this.accessors=new Array(e.accessors.length)),e.bufferViews&&(this.bufferViews=new Array(e.bufferViews.length)),e.scenes&&(this.scenes=new Array(e.scenes.length)),e.nodes&&(this.nodes=new Array(e.nodes.length)),e.meshes&&(this.meshes=new Array(e.meshes.length)),e.materials&&(this.materials=new Array(e.materials.length)),e.textures&&(this.textures=new Array(e.textures.length)),e.samplers&&(this.samplers=new Array(e.samplers.length)),e.images&&(this.images=new Array(e.images.length))},b=MinimalGLTFLoader.glTFLoader=function(e){d=void 0!==e?e:null,this._init(),this.glTF=null};b.prototype._init=function(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._shaderRequested=0,this._shaderLoaded=0,this._imageRequested=0,this._imageLoaded=0,this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null},b.prototype._getBufferViewData=function(e,t,s){var i=this.glTF.bufferViews[t];if(void 0===i){var r=e.bufferViews[t],a=this._buffers[r.buffer];if(a)console.log("dependent buffer data ready (instant), create bufferView "+t),this.glTF.bufferViews[t]=i=new l(r,a),s(i),this._checkComplete();else{this._pendingTasks++;var n=this._bufferTasks[r.buffer];n||(this._bufferTasks[r.buffer]=[],n=this._bufferTasks[r.buffer]);var o=this;n.push(function(e){o._finishedPendingTasks++,i=o.glTF.bufferViews[t],void 0===i?(console.log("create new BufferView Data for "+t),i=o.glTF.bufferViews[t]=new l(r,e)):console.log("dependent buffer data ready (queued), create bufferView "+t),s(i)})}}else console.log("use cached bufferView "+t),s(i)},b.prototype._checkComplete=function(){this._bufferRequested==this._bufferLoaded&&this._imageRequested==this._imageLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks==this._finishedPendingTasks&&(this._postprocess(),this.onload(this.glTF))},b.prototype._parseGLTF=function(e){function t(){var t=e.accessors[s],i=s;return function(e){n.glTF.accessors[i]=new o(t,e)}}var s,i,r,n=this;if(e.accessors)for(s=0,i=e.accessors.length;i>s;s++)r=e.accessors[s],void 0!==r.bufferView&&this._getBufferViewData(e,r.bufferView,t());if(e.textures)for(s=0,i=e.textures.length;i>s;s++)this.glTF.textures[s]=new m(e.textures[s]);if(e.samplers)for(s=0,i=e.samplers.length;i>s;s++)this.glTF.samplers[s]=new f(e.samplers[s]);if(e.materials)for(s=0,i=e.materials.length;i>s;s++)this.glTF.materials[s]=new g(e.materials[s]);if(e.scenes)for(var l=0,h=e.scenes.length;h>l;l++){var u=new a;this.glTF.scenes[l]=u;for(var c=e.scenes[l],d=c.nodes,T=d.length,v=0;T>v;++v){var p=d[v];u.nodes[v]=this._parseNode(e,p)}}this._parseDone=!0,this._checkComplete()},b.prototype._parseMesh=function(e,t){if(void 0!==this.glTF.meshes[t])return this.glTF.meshes[t];var s=new u;this.glTF.meshes[t]=s;for(var i,r=e.meshes[t],a=r.primitives,n=a.length,o=0;n>o;++o)i=a[o],s.primitives.push(new c(e,i));return s};var x=vec3.create(),F=quat.create(),_=vec3.create(),y=mat4.create();b.prototype._parseNode=function(e,t){if(void 0!==this.glTF.nodes[t])return this.glTF.nodes[t];var s=e.nodes[t],i=new h(t);this.glTF.nodes[t]=i;var r=i.matrix;if(s.hasOwnProperty("matrix"))for(var a=0;16>a;++a)r[a]=s.matrix[a];else s.translation?vec3.set(x,s.translation[0],s.translation[1],s.translation[2]):vec3.set(x,0,0,0),s.rotation?quat.set(F,s.rotation[0],s.rotation[1],s.rotation[2],s.rotation[3]):quat.set(F,0,0,0,1),s.scale?vec3.set(_,s.scale[0],s.scale[1],s.scale[2]):vec3.set(_,1,1,1),mat4.fromRotationTranslation(y,F,x),mat4.scale(r,y,_);void 0!==s.mesh&&(i.mesh=this._parseMesh(e,s.mesh));var n=s.children;if(n)for(var o=n.length,l=0;o>l;++l){var u=n[l];i.children[l]=this._parseNode(e,u)}return i},b.prototype.loadGLTF=function(a,n){this._init(),this.onload=n||function(e){console.log("glTF model loaded."),console.log(e)},this.baseUri=e(a);var o=this;t(a,function(e){var t=JSON.parse(e);r=o.glTF=new p(t);var a,n=function(e){if(o._buffers[a]=e,o._bufferLoaded++,o._bufferTasks[a]){var t,s;for(t=0,s=o._bufferTasks[a].length;s>t;++t)o._bufferTasks[a][t](e)}o._checkComplete()};if(t.buffers)for(a in t.buffers)o._bufferRequested++,s(o.baseUri+t.buffers[a].uri,n);var l,h=function(e,t){o._imageLoaded++,o.glTF.images[t]=e,o._checkComplete()};if(t.images)for(l in t.images)o._imageRequested++,i(o.baseUri+t.images[l].uri,l,h);o._parseGLTF(t)})},b.prototype._postprocess=function(){function e(e,t){var s=m[e.nodeID];null!==t?mat4.mul(s,m[t.nodeID],e.matrix):mat4.copy(s,e.matrix)}function t(e,t){var s,i=m[e.nodeID];s=null!==t?t.bvh:o.boundingBox,e.mesh&&(h=e.mesh,h.boundingBox&&(e.aabb=n.getAABBFromOBB(h.boundingBox,i),0===e.children.length&&(vec3.copy(e.bvh.min,e.aabb.min),vec3.copy(e.bvh.max,e.aabb.max)))),vec3.min(s.min,s.min,e.bvh.min),vec3.max(s.max,s.max,e.bvh.max)}console.log("finish loading all assets, do a second pass postprocess");var s,i,r,a,o,l,h,u,c;for(s=0,i=this.glTF.meshes.length;i>s;s++){for(h=this.glTF.meshes[s],h.boundingBox=new n,r=0,a=h.primitives.length;a>r;r++)u=h.primitives[r],void 0!==u.attributes.POSITION&&(c=this.glTF.accessors[u.attributes.POSITION],c.max&&"VEC3"===c.type&&(u.boundingBox=new n(vec3.fromValues(c.min[0],c.min[1],c.min[2]),vec3.fromValues(c.max[0],c.max[1],c.max[2]),!1),u.boundingBox.calculateTransform(),h.boundingBox.updateBoundingBox(u.boundingBox)));h.boundingBox.calculateTransform()}var m=new Array(this.glTF.nodes.length);for(s=0,i=m.length;i>s;s++)m[s]=mat4.create();for(s=0,i=this.glTF.scenes.length;i>s;s++){for(o=this.glTF.scenes[s],o.boundingBox=new n,r=0,a=o.nodes.length;a>r;r++)l=o.nodes[r],l.traverseTwoExecFun(null,e,t);o.boundingBox.calculateTransform()}for(r=0,a=this.glTF.nodes.length;a>r;r++)l=this.glTF.nodes[r],null!==l.bvh&&l.bvh.calculateTransform();if(this.glTF.textures)for(s=0,i=this.glTF.textures.length;i>s;s++)this.glTF.samplers&&null!==this.glTF.textures[s].sampler&&(this.glTF.textures[s].sampler=this.glTF.samplers[this.glTF.textures[s].sampler]),this.glTF.images&&null!==this.glTF.textures[s].source&&(this.glTF.textures[s].source=this.glTF.images[this.glTF.textures[s].source])};var w={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};MinimalGLTFLoader.Attributes=["POSITION","NORMAL","TEXCOORD","COLOR","JOINT","WEIGHT"]}();