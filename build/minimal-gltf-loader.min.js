var MinimalGLTFLoader=MinimalGLTFLoader||{};!function(){"use strict";function e(e){var s="",t=e.lastIndexOf("/");return-1!==t&&(s=e.substring(0,t+1)),s}function s(e,s){var t=new XMLHttpRequest;t.overrideMimeType("application/json"),t.open("GET",e,!0),t.onreadystatechange=function(){4==t.readyState&&"200"==t.status&&s(t.responseText,this)},t.send(null)}function t(e,s){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.open("GET",e,!0),t.onreadystatechange=function(){if(4==t.readyState&&"200"==t.status){var e=t.response;e&&s&&s(e)}},t.send(null)}function i(e,s,t){var i=new Image;i.src=e,i.onload=function(){t(i,s)}}var n=MinimalGLTFLoader.Scene=function(){this.nodes=[],this.boundingBox=null},r=MinimalGLTFLoader.BoundingBox=function(e,s){this.min=e,this.max=s,this.transform=mat4.create()};r.prototype.updateBoundingBox=function(e){vec3.min(this.min,this.min,e.min),vec3.max(this.max,this.max,e.max)},r.prototype.calculateTransform=function(){this.transform[0]=this.max[0]-this.min[0],this.transform[5]=this.max[1]-this.min[1],this.transform[10]=this.max[2]-this.min[2],this.transform[12]=this.min[0],this.transform[13]=this.min[1],this.transform[14]=this.min[2]};var o=MinimalGLTFLoader.Accessor=function(e,s){this.bufferView=s,this.componentType=e.componentType,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=s.byteStride,this.normalized=void 0!==e.normalized?e.normalized:!1,this.count=e.count,this.type=e.type,this.size=v[this.type],this.min=e.min,this.max=e.max},a=MinimalGLTFLoader.BufferView=function(e,s){this.byteLength=e.byteLength,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=void 0!==e.byteStride?e.byteStride:0,this.target=void 0!==e.target?e.target:null,this.data=s.slice(this.byteOffset,this.byteOffset+this.byteLength),this.buffer=null},f=MinimalGLTFLoader.Node=function(e){this.nodeID=e,this.matrix=mat4.create(),this.children=[],this.mesh=null};f.prototype.traverse=function(e,s){s(this,e);for(var t=0,i=this.children.length;i>t;t++)this.children[t].traverse(this,s)};var h,u=MinimalGLTFLoader.Mesh=function(){this.meshID=-1,this.primitives=[],this.boundingBox=null},c=MinimalGLTFLoader.Primitive=function(e,s){this.attributes=s.attributes,this.indices=void 0!==s.indices?s.indices:null,this.indicesComponentType=e.accessors[this.indices].componentType,this.indicesLength=e.accessors[this.indices].count,this.indicesOffset=e.accessors[this.indices].byteOffset||0,this.material=void 0!==s.material?e.materials[s.material]:null,this.mode=void 0!==s.mode?s.mode:4,this.targets=s.targets,this.vertexArray=null,this.vertexBuffer=null,this.indexBuffer=null,this.boundingBox=null},d=MinimalGLTFLoader.glTFModel=function(e){this.json=e,this.defaultScene=e.scene,this.version=Number(e.asset.version),e.accessors&&(this.accessors=new Array(e.accessors.length)),e.bufferViews&&(this.bufferViews=new Array(e.bufferViews.length)),e.scenes&&(this.scenes=new Array(e.scenes.length)),e.nodes&&(this.nodes=new Array(e.nodes.length)),e.meshes&&(this.meshes=new Array(e.meshes.length)),e.images&&(this.images=new Array(e.images.length))},l=MinimalGLTFLoader.glTFLoader=function(e){h=void 0!==e?e:null,this._init(),this.glTF=null};l.prototype._init=function(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._shaderRequested=0,this._shaderLoaded=0,this._imageRequested=0,this._imageLoaded=0,this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null},l.prototype._getBufferViewData=function(e,s,t){var i=this.glTF.bufferViews[s];if(void 0===i){var n=e.bufferViews[s],r=this._buffers[n.buffer];if(r)console.log("dependent buffer data ready (instant), create bufferView "+s),this.glTF.bufferViews[s]=i=new a(n,r),t(i),this._checkComplete();else{this._pendingTasks++;var o=this._bufferTasks[n.buffer];o||(this._bufferTasks[n.buffer]=[],o=this._bufferTasks[n.buffer]);var f=this;o.push(function(e){f._finishedPendingTasks++,i=f.glTF.bufferViews[s],void 0===i?(console.log("create new BufferView Data for "+s),i=f.glTF.bufferViews[s]=new a(n,e)):console.log("dependent buffer data ready (queued), create bufferView "+s),t(i)})}}else console.log("use cached bufferView "+s),t(i)},l.prototype._checkComplete=function(){this._bufferRequested==this._bufferLoaded&&this._imageRequested==this._imageLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks==this._finishedPendingTasks&&(this._postprocess(),this.onload(this.glTF))},l.prototype._parseGLTF=function(e){var s,t,i,r=this;if(e.accessors)for(s=0,t=e.accessors.length;t>s;s++)i=e.accessors[s],void 0!==i.bufferView&&this._getBufferViewData(e,i.bufferView,function(){var t=e.accessors[s],i=s;return function(e){r.glTF.accessors[i]=new o(t,e)}}());if(e.scenes)for(var a=0,f=e.scenes.length;f>a;a++){var h=new n;this.glTF.scenes[a]=h;for(var u=e.scenes[a],c=u.nodes,d=c.length,l=0;d>l;++l){var m=c[l];h.nodes[l]=this._parseNode(e,m)}}this._parseDone=!0,this._checkComplete()},l.prototype._parseMesh=function(e,s){if(void 0!==this.glTF.meshes[s])return this.glTF.meshes[s];var t=new u;this.glTF.meshes[s]=t;for(var i,n=e.meshes[s],r=n.primitives,o=r.length,a=0;o>a;++a)i=r[a],t.primitives.push(new c(e,i));return t};var m=vec3.create(),g=quat.create(),b=vec3.create(),T=mat4.create();l.prototype._parseNode=function(e,s){if(void 0!==this.glTF.nodes[s])return this.glTF.nodes[s];var t=e.nodes[s],i=new f(s);this.glTF.nodes[s]=i;var n=i.matrix;if(t.hasOwnProperty("matrix"))for(var r=0;16>r;++r)n[r]=t.matrix[r];else t.translation?vec3.set(m,t.translation[0],t.translation[1],t.translation[2]):vec3.set(m,0,0,0),t.rotation?quat.set(g,t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3]):quat.set(g,0,0,0,1),t.scale?vec3.set(b,t.scale[0],t.scale[1],t.scale[2]):vec3.set(b,1,1,1),mat4.fromRotationTranslation(T,g,m),mat4.scale(n,T,b);void 0!==t.mesh&&(i.mesh=this._parseMesh(e,t.mesh));var o=t.children;if(o)for(var a=o.length,h=0;a>h;++h){var u=o[h];i.children[h]=this._parseNode(e,u)}return i},l.prototype.loadGLTF=function(n,r){this._init(),this.onload=r||function(e){console.log("glTF model loaded."),console.log(e)},this.baseUri=e(n);var o=this;s(n,function(e){var s=JSON.parse(e);o.glTF=new d(s);var n,r=function(e){if(o._buffers[n]=e,o._bufferLoaded++,o._bufferTasks[n]){var s,t;for(s=0,t=o._bufferTasks[n].length;t>s;++s)o._bufferTasks[n][s](e)}o._checkComplete()};if(s.buffers)for(n in s.buffers)o._bufferRequested++,t(o.baseUri+s.buffers[n].uri,r);var a,f=function(e,s){o._imageLoaded++,o.glTF.images[s]=e,o._checkComplete()};if(s.images)for(a in s.images)o._imageRequested++,i(o.baseUri+s.images[a].uri,a,f);o._parseGLTF(s)})},l.prototype._postprocess=function(){function e(e,s){var t=l[e.nodeID];null!==s?mat4.mul(t,l[s.nodeID],e.matrix):mat4.copy(t,e.matrix),e.mesh&&(f=e.mesh,f.boundingBox&&(vec3.transformMat4(c,f.boundingBox.min,t),vec3.transformMat4(d,f.boundingBox.max,t),vec3.min(o.boundingBox.min,o.boundingBox.min,c),vec3.min(o.boundingBox.min,o.boundingBox.min,d),vec3.max(o.boundingBox.max,o.boundingBox.max,d),vec3.max(o.boundingBox.max,o.boundingBox.max,c)))}console.log("finish loading all assets, do a second pass postprocess");var s,t,i,n,o,a,f,h,u;for(s=0,t=this.glTF.meshes.length;t>s;s++){for(f=this.glTF.meshes[s],f.boundingBox=new r(vec3.fromValues(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),vec3.fromValues(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),i=0,n=f.primitives.length;n>i;i++)h=f.primitives[i],void 0!==h.attributes.POSITION&&(u=this.glTF.accessors[h.attributes.POSITION],u.max&&"VEC3"===u.type&&(h.boundingBox=new r(vec3.fromValues(u.min[0],u.min[1],u.min[2]),vec3.fromValues(u.max[0],u.max[1],u.max[2])),h.boundingBox.calculateTransform(),f.boundingBox.updateBoundingBox(h.boundingBox)));f.boundingBox.calculateTransform()}var c=vec3.create(),d=vec3.create(),l=new Array(this.glTF.nodes.length);for(s=0,t=l.length;t>s;s++)l[s]=mat4.create();for(s=0,t=this.glTF.scenes.length;t>s;s++){for(o=this.glTF.scenes[s],o.boundingBox=new r(vec3.fromValues(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),vec3.fromValues(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),i=0,n=o.nodes.length;n>i;i++)a=o.nodes[i],a.traverse(null,e);o.boundingBox.calculateTransform()}};var v={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};MinimalGLTFLoader.Attributes=["POSITION","NORMAL","TEXCOORD","COLOR","JOINT","WEIGHT"]}();